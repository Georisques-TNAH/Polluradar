{% extends "partials/conteneur.html" %}

{% block body %}
<div class="container">
    <h1 style="text-align: center;">Nombre d'établissements en fonction du milieu pollué par département</h1>
    <ul id="liste" style="text-align: center;"></ul>
</div>

<script>
    // Charger les données des établissements par département
    fetch('/graph2_donnees')
        .then(response => response.json())
        .then(data => {
            // Dictionnaire pour stocker les données par département
            var dicoDepartement = {};

            // Regrouper les données par département
            data.forEach(entry => {
                if (!dicoDepartement[entry.departement]) {
                    dicoDepartement[entry.departement] = [];
                }
                dicoDepartement[entry.departement].push({ milieu_pollue: entry.milieu_pollue, nombre_etablissements: entry.nombre_etablissements });
            });

            // Parcoure les données pour chaque département
            Object.keys(dicoDepartement).forEach(departement => {
                // Création d'un tableau pour stocker les données du camembert
                var donneesCamembert = {
                    labels: [],
                    data: [],
                    backgroundColor: ['#8a74ff', '#e24545', '#45e28f', '#dde245', '#45d7e2', '#cb45e2', '#e24585', '#e2a545'],
                };

                // Nombre total d'établissements dans le département
                var totalEtablissements = dicoDepartement[departement].reduce((total, entry) => total + entry.nombre_etablissements, 0);

                // Ajoute les données du camembert pour chaque milieu pollué
                dicoDepartement[departement].forEach(entry => {
                    donneesCamembert.labels.push(entry.milieu_pollue);
                    donneesCamembert.data.push(entry.nombre_etablissements);
                });

                // Création d'un canvas pour le camembert
                var canvas = document.createElement('canvas');
                canvas.width = 20;
                canvas.height = 20;

                // Implémentation du camembert dans le canvas
                var ctx = canvas.getContext('2d');
                var chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: donneesCamembert.labels,
                        datasets: [{
                            data: donneesCamembert.data,
                            backgroundColor: donneesCamembert.backgroundColor,
                        }],
                    },
                });

                // Création d'une div pour contenir le camembert et le titre du département
                var container = document.createElement('div');

                // Titre pour le département
                var title = document.createElement('h3');
                title.textContent = departement;
                title.style.textAlign = 'center';


                // Ajout du camembert et de son titre au conteneur
                container.appendChild(title);
                container.appendChild(canvas);

                // Création d'une puce pour chaque camembert
                var listItem = document.createElement('li');
                listItem.classList.add('camembert');
                listItem.appendChild(container);

                // Ajout de la puce qui vient d'être créée à la liste de camemberts
                document.getElementById('liste').appendChild(listItem);
            });

        // Message d'erreur affiché dans la console en cas de problème de chargement des données
        })
        .catch(error => {
            console.error('Erreur lors du chargement des données :', error);
        });
</script>

{% endblock %}
